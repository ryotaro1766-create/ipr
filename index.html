<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>リアルタイム複数人位置情報共有デモ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SJPMeMy/0+HKSz9zVd"
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20n6a9c97aT28/S6Qsh8p7z40yJz8J+FpS+fM0C0F0c="
            crossorigin=""></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1 { color: #333; margin-bottom: 20px; }
        .map-wrapper { width: 90%; max-width: 800px; border: 2px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 10px; background-color: #fff; }
        #map { height: 500px; width: 100%; margin-top: 10px; }
        .controls { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .controls label, .controls input { margin-right: 10px; }
        button { padding: 8px 15px; font-size: 14px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>リアルタイム複数人位置情報共有デモ</h1>
    <p>地図をクリックすると、選択したユーザーの位置情報が共有されます。</p>

    <div class="map-wrapper">
        <div class="controls">
            <label for="userIdSelect">共有するユーザー:</label>
            <select id="userIdSelect">
                <option value="user1">ユーザーA (あなた)</option>
                <option value="user2">ユーザーB (シミュレート)</option>
                <option value="user3">ユーザーC (シミュレート)</option>
            </select>
            <button id="realGpsBtn">GPS追跡開始 (選択ユーザー)</button>
        </div>
        <div id="map"></div>
    </div>

    <script>
        // --- 1. マップの初期設定 (Leaflet.jsを使用) ---
        const initialLat = 35.6895; // 東京
        const initialLng = 139.6917;

        // マップの初期化
        const map = L.map('map').setView([initialLat, initialLng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // --- 2. 複数マーカー管理用オブジェクト ---
        // { 'user1': L.markerオブジェクト, 'user2': L.markerオブジェクト, ... }
        const markerCache = {}; 

        // --- 3. リアルタイム通信のシミュレーション (Event Emitter) ---
        const EventEmitter = {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) { this.listeners[event] = []; }
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
            }
        };

        // --- 4. マーカーの作成・更新関数 ---
        function updateMarker(userId, lat, lng) {
            const newLatLng = L.latLng(lat, lng);
            
            if (markerCache[userId]) {
                // 既存マーカーがある場合: 位置を更新
                markerCache[userId].setLatLng(newLatLng);
                markerCache[userId].getPopup().setContent(`ID: ${userId}<br>最終更新: ${new Date().toLocaleTimeString()}`);
            } else {
                // 新規マーカーの場合: 作成して地図に追加し、キャッシュに保存
                const marker = L.marker(newLatLng)
                    .addTo(map)
                    .bindPopup(`ID: ${userId}<br>最終更新: ${new Date().toLocaleTimeString()}`);
                markerCache[userId] = marker;
            }
        }

        // --- 5. 位置情報の送信 (地図クリック) ---
        map.on('click', function(e) {
            const latlng = e.latlng;
            const userId = document.getElementById('userIdSelect').value;
            
            // 選択されたユーザーとして位置情報を送信
            sendLocation(userId, latlng.lat, latlng.lng);
            map.setView(latlng, map.getZoom());
        });
        
        // サーバーへの送信処理 (シミュレーション)
        function sendLocation(userId, lat, lng) {
            // 自身の地図のマーカーを更新
            updateMarker(userId, lat, lng); 

            // リアルタイムイベントを発火 (他のユーザーにブロードキャストをシミュレート)
            EventEmitter.emit('location_update', { userId: userId, lat: lat, lng: lng });
            console.log(`[送信] ユーザーID: ${userId}, Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`);
        }


        // --- 6. リアルタイム位置情報の受信と描画 ---
        
        // リアルタイムイベントの受信処理
        EventEmitter.on('location_update', (data) => {
            // 受信したデータに含まれるuserIdに基づいてマーカーを更新
            updateMarker(data.userId, data.lat, data.lng);
            console.log(`[受信] ユーザーID: ${data.userId} の位置を受信し更新しました。`);
        });
        
        // --- 7. 実際のGPS追跡機能 ---
        let watchId = null; // watchPositionのIDを保持するための変数

        document.getElementById('realGpsBtn').addEventListener('click', () => {
            const btn = document.getElementById('realGpsBtn');
            const userId = document.getElementById('userIdSelect').value;

            if (watchId) {
                // 既に追跡中の場合は停止
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                btn.textContent = "GPS追跡開始 (" + userId + ")";
                console.log(`[GPS] ${userId} の追跡を停止しました。`);
                return;
            }

            if (navigator.geolocation) {
                btn.textContent = "GPS追跡中... (停止)";

                // watchPositionを開始し、IDを保存
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        // 選択中のユーザーIDで位置情報を送信
                        sendLocation(userId, lat, lng);
                        map.setView([lat, lng], map.getZoom()); // マップを現在地に移動
                    },
                    (error) => {
                        alert('GPS位置情報取得に失敗しました: ' + error.message);
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                        btn.textContent = "GPS追跡開始 (" + userId + ")";
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
                console.log(`[GPS] ${userId} の追跡を開始しました。`);
            } else {
                alert("お使いのブラウザは Geolocation API をサポートしていません。");
            }
        });

    </script>
</body>
</html>