<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>リアルタイム位置情報共有デモ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SJPMeMy/0+HKSz9zVd"
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20n6a9c97aT28/S6Qsh8p7z40yJz8J+FpS+fM0C0F0c="
            crossorigin=""></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1 { color: #333; margin-bottom: 30px; }
        .map-container { display: flex; justify-content: space-around; width: 100%; max-width: 1200px; }
        .map-wrapper { width: 48%; border: 2px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 10px; background-color: #fff; }
        .map-box { height: 400px; width: 100%; margin-top: 10px; }
        .controls { margin-bottom: 10px; text-align: center; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>リアルタイム位置情報共有デモ (ブラウザ内シミュレーション)</h1>

    <div class="map-container">
        <div class="map-wrapper">
            <div class="controls">
                <h2>ユーザーA (送信者)</h2>
                <p>この地図でドラッグまたはクリックすると、位置情報がリアルタイムで送信されます。</p>
                <button id="realGpsBtn">現在のGPS位置を追跡開始</button>
            </div>
            <div id="mapA" class="map-box"></div>
        </div>

        <div class="map-wrapper">
            <div class="controls">
                <h2>ユーザーB (受信者)</h2>
                <p>ユーザーAのマーカーがリアルタイムで更新されます。</p>
            </div>
            <div id="mapB" class="map-box"></div>
        </div>
    </div>

    <script>
        // --- 1. マップの初期設定 (Leaflet.jsを使用) ---
        const initialLat = 35.6895; // 東京
        const initialLng = 139.6917;

        // マップA (送信者)
        const mapA = L.map('mapA').setView([initialLat, initialLng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(mapA);
        const markerA = L.marker([initialLat, initialLng]).addTo(mapA).bindPopup("ユーザーA (送信者)");

        // マップB (受信者)
        const mapB = L.map('mapB').setView([initialLat, initialLng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(mapB);
        const markerB = L.marker([initialLat, initialLng], { icon: L.divIcon({className: 'blinking-marker', html: '<div style="background-color: red; width: 10px; height: 10px; border-radius: 50%; animation: blink 1s infinite;"></div>'})}).addTo(mapB).bindPopup("ユーザーA (受信位置)");

        // 点滅マーカーのCSSアニメーションを動的に追加
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.3; }
                100% { opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // --- 2. リアルタイム通信のシミュレーション (Event Emitter) ---
        // 実際のアプリでは、この部分は WebSocket や Firebase に置き換わります。
        const EventEmitter = {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) {
                    this.listeners[event] = [];
                }
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
            }
        };

        // --- 3. 位置情報の送信 (マップAの操作やGPSから) ---

        // A. マップクリック/ドラッグによる位置情報送信シミュレーション
        mapA.on('click', function(e) {
            const latlng = e.latlng;
            sendLocation(latlng.lat, latlng.lng);
            mapA.setView(latlng, mapA.getZoom());
        });

        // B. 実際のGPSによる位置情報送信 (ボタンクリックで開始)
        document.getElementById('realGpsBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        sendLocation(lat, lng);
                        mapA.setView([lat, lng], mapA.getZoom()); // マップAを現在地に移動
                        markerA.setPopupContent("ユーザーA (送信者)<br>GPS追跡中").openPopup();
                    },
                    (error) => {
                        alert('GPS位置情報取得に失敗しました: ' + error.message);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
                document.getElementById('realGpsBtn').textContent = "GPS追跡中...";
                document.getElementById('realGpsBtn').disabled = true;
            } else {
                alert("お使いのブラウザは Geolocation API をサポートしていません。");
            }
        });


        // サーバーへの送信処理 (シミュレーション)
        function sendLocation(lat, lng) {
            // マーカーAを更新
            markerA.setLatLng([lat, lng]);
            // リアルタイムイベントを発火
            EventEmitter.emit('location_update', { lat: lat, lng: lng });
            console.log(`[送信A] Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`);
        }


        // --- 4. 位置情報の受信と描画 (マップB) ---

        // リアルタイムイベントの受信処理
        EventEmitter.on('location_update', (data) => {
            receiveLocation(data.lat, data.lng);
        });

        // 受信した位置情報でマーカーBを更新
        function receiveLocation(lat, lng) {
            const newLatLng = L.latLng(lat, lng);
            
            // マーカーを滑らかに移動させるアニメーション (Leafletのカスタム機能)
            if (markerB.setLatLng) {
                markerB.setLatLng(newLatLng);
            }
            // 受信位置にマップBを中央に移動
            mapB.setView(newLatLng, mapB.getZoom());
            console.log(`[受信B] Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`);
        }

    </script>
</body>
</html>